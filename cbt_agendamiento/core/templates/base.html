{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    
    <title>{% block title %}CBT Digital{% endblock %}</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: {
                            red: '#CC0000',       
                            dark: '#1D1D1F',      
                            gray: '#86868B',      
                            bg: '#F5F5F7',        /* Gris Apple Clásico */
                            surface: '#FFFFFF',   
                            border: '#E5E5E5',    
                        }
                    },
                    boxShadow: {
                        'apple': '0 4px 12px rgba(0, 0, 0, 0.04)',
                        'apple-hover': '0 12px 24px rgba(0, 0, 0, 0.08)', /* Sombra más difusa */
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.05)',
                    }
                }
            }
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        /* Scrollbar Fino */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #D1D1D6; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #86868B; }
        
        /* Efecto Glass Apple Real (Saturación + Blur) */
        .glass-nav {
            background: rgba(255, 255, 255, 0.75); /* Más transparencia */
            backdrop-filter: blur(20px) saturate(180%); /* El secreto de iOS */
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        /* Sidebar Glass en Móvil */
        .sidebar-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
        }
        
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-brand-bg text-brand-dark antialiased h-screen flex overflow-hidden selection:bg-brand-red selection:text-white font-sans">

    {% if user.is_authenticated and user.is_staff %}
    <!-- OVERLAY MÓVIL -->
    <div id="mobile-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-slate-900/20 z-40 hidden lg:hidden backdrop-blur-sm transition-opacity opacity-0"></div>

    <!-- SIDEBAR (Navegación Lateral) -->
    <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-50 w-72 lg:w-64 bg-brand-surface/95 border-r border-brand-border transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col shadow-2xl lg:shadow-none h-full sidebar-glass">
        
        <!-- HEADER (Logo en Caja Blanca) -->
        <div class="h-20 flex items-center px-6 border-b border-brand-border/50">
            <div class="flex items-center gap-3">
                <!-- LOGO RECUPERADO: Caja Blanca con Sombra -->
                <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center shadow-sm border border-slate-100 p-1.5 transition-transform hover:scale-105">
                    <img src="{% static 'img/logo_cbt.png' %}" alt="Logo" class="w-full h-full object-contain">
                </div>
                <div class="flex flex-col">
                    <span class="font-bold text-lg tracking-tight leading-none text-slate-800">CBT <span class="text-brand-red">Admin</span></span>
                    <span class="text-[10px] text-slate-400 uppercase tracking-widest font-medium mt-0.5">Panel de Control</span>
                </div>
            </div>
            <!-- Botón cerrar solo en móvil -->
            <button onclick="toggleSidebar()" class="ml-auto lg:hidden text-slate-400 hover:text-slate-600">
                <i class="bi bi-x-lg text-xl"></i>
            </button>
        </div>

        <!-- Menú Scrollable -->
        <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-8 custom-scrollbar">
            
            <!-- GRUPO 1: PRINCIPAL -->
            <div>
                <div class="px-3 mb-3 text-[10px] font-bold text-brand-gray uppercase tracking-widest opacity-80">Principal</div>
                <div class="space-y-1">
                    <a href="{% url 'dashboard_staff' %}" class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-xl hover:bg-slate-50 hover:text-brand-red transition-all group {% if request.resolver_match.url_name == 'dashboard_staff' %}bg-red-50 text-brand-red shadow-sm{% else %}text-slate-600{% endif %}">
                        <i class="bi bi-grid-1x2 text-lg {% if request.resolver_match.url_name == 'dashboard_staff' %}text-brand-red{% else %}text-slate-400 group-hover:text-brand-red{% endif %} transition-colors"></i>
                        Dashboard
                    </a>
                    <a href="{% url 'estadisticas_globales' %}" class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-xl hover:bg-slate-50 hover:text-brand-red transition-all group {% if request.resolver_match.url_name == 'estadisticas_globales' %}bg-red-50 text-brand-red shadow-sm{% else %}text-slate-600{% endif %}">
                        <i class="bi bi-pie-chart text-lg {% if request.resolver_match.url_name == 'estadisticas_globales' %}text-brand-red{% else %}text-slate-400 group-hover:text-brand-red{% endif %} transition-colors"></i>
                        Estadísticas
                    </a>
                </div>
            </div>

            <!-- GRUPO 2: OPERACIONES -->
            <div>
                <div class="px-3 mb-3 text-[10px] font-bold text-brand-gray uppercase tracking-widest opacity-80">Flujo Diario</div>
                <div class="space-y-1">
                    <a href="{% url 'solicitudes_pendientes' %}" class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-xl hover:bg-slate-50 hover:text-brand-red transition-all group {% if request.resolver_match.url_name == 'solicitudes_pendientes' %}bg-red-50 text-brand-red shadow-sm{% else %}text-slate-600{% endif %}">
                        <i class="bi bi-inbox text-lg {% if request.resolver_match.url_name == 'solicitudes_pendientes' %}text-brand-red{% else %}text-slate-400 group-hover:text-brand-red{% endif %}"></i>
                        Solicitudes
                    </a>
                    <a href="{% url 'gestion_inspecciones' %}" class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-xl hover:bg-slate-50 hover:text-brand-red transition-all group {% if request.resolver_match.url_name == 'gestion_inspecciones' %}bg-red-50 text-brand-red shadow-sm{% else %}text-slate-600{% endif %}">
                        <i class="bi bi-clipboard-check text-lg {% if request.resolver_match.url_name == 'gestion_inspecciones' %}text-brand-red{% else %}text-slate-400 group-hover:text-brand-red{% endif %}"></i>
                        Inspecciones
                    </a>
                    <a href="{% url 'cierre_inspecciones' %}" class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-xl hover:bg-slate-50 hover:text-brand-red transition-all group {% if request.resolver_match.url_name == 'cierre_inspecciones' %}bg-red-50 text-brand-red shadow-sm{% else %}text-slate-600{% endif %}">
                        <i class="bi bi-check2-square text-lg {% if request.resolver_match.url_name == 'cierre_inspecciones' %}text-brand-red{% else %}text-slate-400 group-hover:text-brand-red{% endif %}"></i>
                        Finalizar
                    </a>
                </div>
            </div>

            <!-- GRUPO 3: VENTANILLA -->
            <div>
                <div class="px-3 mb-3 text-[10px] font-bold text-brand-gray uppercase tracking-widest opacity-80">Ventanilla</div>
                <div class="space-y-1">
                    <a href="{% url 'alta_contribuyente' %}" class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-xl hover:bg-slate-50 hover:text-brand-red transition-all group {% if request.resolver_match.url_name == 'alta_contribuyente' %}bg-red-50 text-brand-red shadow-sm{% else %}text-slate-600{% endif %}">
                        <i class="bi bi-shop text-lg {% if request.resolver_match.url_name == 'alta_contribuyente' %}text-brand-red{% else %}text-slate-400 group-hover:text-brand-red{% endif %}"></i>
                        Nuevo Local
                    </a>
                    <a href="{% url 'buscar_local_presencial' %}" class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-xl hover:bg-slate-50 hover:text-brand-red transition-all group {% if request.resolver_match.url_name == 'buscar_local_presencial' %}bg-red-50 text-brand-red shadow-sm{% else %}text-slate-600{% endif %}">
                        <i class="bi bi-window-stack text-lg {% if request.resolver_match.url_name == 'buscar_local_presencial' %}text-brand-red{% else %}text-slate-400 group-hover:text-brand-red{% endif %}"></i>
                        At. Presencial
                    </a>
                    <a href="{% url 'habilitar_agenda' %}" class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-xl hover:bg-slate-50 hover:text-brand-red transition-all group {% if request.resolver_match.url_name == 'habilitar_agenda' %}bg-red-50 text-brand-red shadow-sm{% else %}text-slate-600{% endif %}">
                        <i class="bi bi-calendar-week text-lg {% if request.resolver_match.url_name == 'habilitar_agenda' %}text-brand-red{% else %}text-slate-400 group-hover:text-brand-red{% endif %}"></i>
                        Agenda Masiva
                    </a>
                </div>
            </div>

            <!-- GRUPO 4: DATOS -->
            <div>
                <div class="px-3 mb-3 text-[10px] font-bold text-brand-gray uppercase tracking-widest opacity-80">Datos</div>
                <div class="space-y-1">
                    <a href="{% url 'directorio_establecimientos' %}" class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-xl hover:bg-slate-50 hover:text-brand-red transition-all group {% if request.resolver_match.url_name == 'directorio_establecimientos' %}bg-red-50 text-brand-red shadow-sm{% else %}text-slate-600{% endif %}">
                        <i class="bi bi-folder2-open text-lg {% if request.resolver_match.url_name == 'directorio_establecimientos' %}text-brand-red{% else %}text-slate-400 group-hover:text-brand-red{% endif %}"></i>
                        Directorio
                    </a>
                    <a href="{% url 'hoja_ruta' %}" class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-xl hover:bg-slate-50 hover:text-brand-red transition-all group {% if request.resolver_match.url_name == 'hoja_ruta' %}bg-red-50 text-brand-red shadow-sm{% else %}text-slate-600{% endif %}">
                        <i class="bi bi-map text-lg {% if request.resolver_match.url_name == 'hoja_ruta' %}text-brand-red{% else %}text-slate-400 group-hover:text-brand-red{% endif %}"></i>
                        Rutas
                    </a>
                    <a href="{% url 'generar_informe_mensual' %}" class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-xl hover:bg-slate-50 hover:text-brand-red transition-all group {% if request.resolver_match.url_name == 'generar_informe_mensual' %}bg-red-50 text-brand-red shadow-sm{% else %}text-slate-600{% endif %}">
                        <i class="bi bi-file-earmark-text text-lg {% if request.resolver_match.url_name == 'generar_informe_mensual' %}text-brand-red{% else %}text-slate-400 group-hover:text-brand-red{% endif %}"></i>
                        Informes
                    </a>
                </div>
            </div>

            <!-- GRUPO 5: ADMIN -->
            {% if request.user.is_superuser %}
            <div>
                <div class="px-2 mb-2 text-[0.65rem] font-bold text-brand-gray uppercase tracking-widest opacity-80">Sistema</div>
                <div class="space-y-1">
                    <a href="{% url 'gestion_tipos' %}" class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-xl hover:bg-slate-50 hover:text-brand-red transition-all group {% if request.resolver_match.url_name == 'gestion_tipos' %}bg-red-50 text-brand-red shadow-sm{% else %}text-slate-600{% endif %}">
                        <i class="bi bi-tags text-lg text-slate-400 group-hover:text-brand-red"></i> Tipos
                    </a>
                    <a href="{% url 'gestion_usuarios' %}" class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-xl hover:bg-slate-50 hover:text-brand-red transition-all group {% if request.resolver_match.url_name == 'gestion_usuarios' %}bg-red-50 text-brand-red shadow-sm{% else %}text-slate-600{% endif %}">
                        <i class="bi bi-shield-lock text-lg text-slate-400 group-hover:text-brand-red"></i> Personal
                    </a>
                     <a href="{% url 'gestion_documentacion' %}" class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-xl hover:bg-slate-50 hover:text-brand-red transition-all group {% if request.resolver_match.url_name == 'gestion_documentacion' %}bg-red-50 text-brand-red shadow-sm{% else %}text-slate-600{% endif %}">
                        <i class="bi bi-book text-lg text-slate-400 group-hover:text-brand-red"></i> Documentación
                    </a>
                </div>
            </div>
            {% endif %}
        </nav>

        <div class="p-4 border-t border-brand-border bg-slate-50/50 backdrop-blur-sm">
            <a href="{% url 'logout' %}" class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-red-50 text-slate-500 hover:text-red-600 transition-all text-sm font-medium group">
                <i class="bi bi-box-arrow-left text-lg group-hover:-translate-x-1 transition-transform"></i> Cerrar Sesión
            </a>
        </div>
    </aside>
    {% endif %}

    <!-- ÁREA PRINCIPAL -->
    <div class="flex-1 flex flex-col min-w-0 overflow-hidden">
        
        <!-- NAVBAR (Glassmorphism) -->
        <header class="h-20 glass-nav flex items-center justify-between px-6 z-40 sticky top-0 w-full transition-all duration-200" id="top-navbar">
            
            <div class="flex items-center gap-4">
                {% if user.is_authenticated and user.is_staff %}
                <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-xl text-slate-500 hover:bg-slate-100 hover:text-brand-dark transition-colors focus:outline-none active:scale-95">
                    <i class="bi bi-list text-2xl"></i>
                </button>
                {% endif %}
                
                <!-- LOGO PRINCIPAL (Link Inteligente) -->
                <a href="{% if user.is_staff %}{% url 'dashboard_staff' %}{% else %}{% url 'home_ciudadano' %}{% endif %}" 
                   class="flex items-center gap-3 group">
                    
                    {% if not user.is_staff %}
                    <!-- LOGO CIUDADANO: Caja Blanca -->
                    <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center shadow-sm border border-slate-100 p-1.5 group-hover:scale-105 transition-transform duration-300">
                         <img src="{% static 'img/logo_cbt.png' %}" alt="Logo" class="w-full h-full object-contain">
                    </div>
                    <div class="flex flex-col leading-none">
                        <span class="font-bold text-brand-dark text-sm">CBT DIGITAL</span>
                        <span class="text-[10px] font-bold text-brand-red tracking-widest uppercase">Tulcán</span>
                    </div>
                    {% else %}
                    <!-- TITULO STAFF -->
                    <h2 class="text-xl font-bold text-brand-dark hidden sm:block tracking-tight animate-fade-in">
                        {% block header_title %}{% endblock %}
                    </h2>
                    {% endif %}
                </a>
            </div>

            <div class="flex items-center gap-4">
                {% if user.is_authenticated %}
                    <!-- Botón Notificaciones -->
                    <div class="relative">
                        <button id="btnNotif" onclick="toggleDropdown('dropdownNotif')" class="p-2.5 rounded-full text-slate-500 hover:bg-white hover:shadow-sm hover:text-brand-red transition-all relative focus:outline-none active:scale-95">
                            <i class="bi bi-bell text-xl"></i>
                            <span id="notif-badge" class="absolute top-2 right-2 w-2.5 h-2.5 bg-brand-red rounded-full border-2 border-white hidden animate-pulse"></span>
                        </button>
                        <!-- Dropdown Flotante -->
                        <div id="dropdownNotif" class="hidden absolute right-0 mt-3 w-80 bg-white/95 backdrop-blur-xl rounded-2xl shadow-apple-hover border border-white/20 overflow-hidden z-50 origin-top-right">
                            <div class="px-4 py-3 border-b border-brand-border bg-slate-50/50">
                                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Notificaciones</h3>
                            </div>
                            <ul id="notif-list" class="max-h-80 overflow-y-auto">
                                <li class="p-6 text-center text-slate-400 text-sm">Sin novedades</li>
                            </ul>
                        </div>
                    </div>

                    <div class="h-8 w-px bg-slate-200/60 hidden md:block"></div>

                    <!-- Usuario -->
                    <div class="relative">
                        <button onclick="toggleDropdown('dropdownUser')" class="flex items-center gap-3 focus:outline-none group pl-2 py-1 pr-1 rounded-full hover:bg-white/50 transition-colors">
                            <div class="text-right hidden md:block leading-tight">
                                <div class="text-sm font-bold text-brand-dark group-hover:text-brand-red transition-colors">{{ user.first_name }}</div>
                                <div class="text-[10px] font-bold text-slate-400 uppercase">{% if user.is_staff %}Inspector{% else %}Ciudadano{% endif %}</div>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-100 to-slate-200 border border-white flex items-center justify-center text-brand-red font-bold text-sm shadow-sm group-hover:ring-2 group-hover:ring-brand-red/20 transition-all">
                                {{ user.first_name|first }}
                            </div>
                        </button>
                        <!-- Dropdown Usuario -->
                        <div id="dropdownUser" class="hidden absolute right-0 mt-3 w-56 bg-white/95 backdrop-blur-xl rounded-2xl shadow-apple-hover border border-white/20 p-1.5 z-50 origin-top-right animate-fade-in">
                            <div class="px-3 py-2 mb-1 border-b border-slate-100 md:hidden">
                                <p class="text-sm font-bold text-slate-800">{{ user.first_name }} {{ user.last_name }}</p>
                                <p class="text-xs text-slate-500">{% if user.is_staff %}Inspector{% else %}Ciudadano{% endif %}</p>
                            </div>
                            <a href="{% url 'mi_perfil' %}" class="flex items-center gap-3 px-4 py-2.5 text-sm text-slate-600 hover:bg-slate-50 hover:text-brand-dark rounded-xl transition-colors">
                                <i class="bi bi-person-circle text-slate-400"></i> Mi Perfil
                            </a>
                            <div class="h-px bg-slate-100 my-1 mx-2"></div>
                            <a href="{% url 'logout' %}" class="flex items-center gap-3 px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 rounded-xl transition-colors font-medium">
                                <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                            </a>
                        </div>
                    </div>
                {% else %}
                    <a href="{% url 'login' %}" class="bg-brand-dark hover:bg-slate-800 text-white px-6 py-2.5 rounded-full text-sm font-bold shadow-lg shadow-slate-900/10 transition-all hover:-translate-y-0.5 active:scale-95">
                        Iniciar Sesión
                    </a>
                {% endif %}
            </div>
        </header>

        <!-- CONTENIDO -->
        <main class="flex-1 overflow-y-auto bg-brand-bg p-4 md:p-8 fade-in">
            <div class="max-w-7xl mx-auto">
                {% if messages %}
                    <div class="mb-8 space-y-3">
                        {% for message in messages %}
                        <div class="flex items-center p-4 rounded-2xl bg-white/80 backdrop-blur-sm border-l-4 shadow-apple relative overflow-hidden group animate-fade-in
                            {% if 'success' in message.tags %} border-emerald-500 text-emerald-700
                            {% elif 'warning' in message.tags %} border-amber-500 text-amber-700
                            {% elif 'error' in message.tags %} border-red-500 text-red-700
                            {% else %} border-blue-500 text-blue-700 {% endif %}">
                            
                            <div class="absolute inset-0 bg-current opacity-[0.02] pointer-events-none"></div>
                            
                            <div class="flex items-center gap-3 z-10">
                                {% if 'success' in message.tags %} <i class="bi bi-check-circle-fill text-xl"></i>
                                {% elif 'warning' in message.tags %} <i class="bi bi-exclamation-triangle-fill text-xl"></i>
                                {% elif 'error' in message.tags %} <i class="bi bi-x-circle-fill text-xl"></i>
                                {% else %} <i class="bi bi-info-circle-fill text-xl"></i> {% endif %}
                                <span class="text-sm font-medium">{{ message }}</span>
                            </div>
                            <button onclick="this.parentElement.remove()" class="ml-auto text-current opacity-40 hover:opacity-100 transition-opacity p-1"><i class="bi bi-x-lg"></i></button>
                        </div>
                        {% endfor %}
                    </div>
                {% endif %}
                {% block content %}{% endblock %}
            </div>
            <footer class="py-10 text-center border-t border-slate-200/60 mt-8">
                <p class="text-xs text-slate-400 font-medium">
                    &copy; 2025 Cuerpo de Bomberos de Tulcán. <span class="text-brand-red font-semibold">Disciplina y Abnegación.</span>
                </p>
            </footer>
        </main>
    </div>

    <!-- LOADER GLOBAL (Centrado Perfecto Apple) -->
    <div id="global-loader" class="fixed inset-0 z-[9999] bg-white/60 backdrop-blur-md hidden flex items-center justify-center transition-opacity duration-300 opacity-0">
        <div class="bg-white/80 backdrop-blur-xl shadow-2xl rounded-3xl p-8 flex flex-col items-center justify-center border border-white/50 w-40 h-40">
            <!-- Spinner SVG -->
            <svg class="animate-spin h-10 w-10 text-brand-red mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Cargando</span>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('mobile-overlay');
            sb.classList.toggle('-translate-x-full');
            ov.classList.toggle('hidden');
        }
        function toggleDropdown(id) {
            const el = document.getElementById(id);
            document.querySelectorAll('[id^="dropdown"]').forEach(d => { if (d.id !== id) d.classList.add('hidden'); });
            el.classList.toggle('hidden');
        }
        window.onclick = function(e) {
            if (!e.target.closest('.relative')) {
                document.querySelectorAll('[id^="dropdown"]').forEach(d => d.classList.add('hidden'));
            }
        }

        // LOADER LOGIC
        const loader = document.getElementById('global-loader');
        function showLoader() { 
            loader.classList.remove('hidden'); 
            void loader.offsetWidth; 
            loader.classList.add('flex'); 
            setTimeout(() => loader.classList.remove('opacity-0'), 10); 
        }
        function hideLoader() { 
            loader.classList.add('opacity-0'); 
            setTimeout(() => {
                loader.classList.add('hidden');
                loader.classList.remove('flex');
            }, 300); 
        }
        
        document.addEventListener('submit', function(e) { if(!e.target.target) showLoader(); });
        document.addEventListener('click', function(e) {
            const link = e.target.closest('a');
            if (link && link.href && !link.href.startsWith('#') && !link.href.includes('javascript') && link.target !== '_blank' && !link.getAttribute('download')) showLoader();
        });
        window.addEventListener('pageshow', function(event) { if (event.persisted) hideLoader(); });

        // NOTIFICACIONES
        {% if user.is_authenticated %}
        document.addEventListener('DOMContentLoaded', () => {
            checkNotifications(); setInterval(() => { if(!document.hidden) checkNotifications(); }, 30000);
        });
        function checkNotifications() {
            fetch('/api/notificaciones/').then(r=>r.json()).then(d=>{
                const badge = document.getElementById('notif-badge'); const list = document.getElementById('notif-list');
                if(d.count > 0) {
                    badge.classList.remove('hidden');
                    let html = '';
                    d.notificaciones.forEach(n => {
                        let icon = n.tipo === 'SUCCESS' ? 'bi-check-circle-fill text-emerald-500' : 'bi-info-circle-fill text-blue-500';
                        html += `<li class="border-b border-slate-50"><a href="#" onclick="markAsRead(${n.id}, '${n.link}')" class="block px-4 py-3 hover:bg-slate-50 transition-colors"><div class="flex justify-between mb-1"><span class="text-xs font-bold text-slate-700 flex items-center gap-2"><i class="bi ${icon}"></i> ${n.titulo}</span><span class="text-[10px] text-slate-400">${n.fecha}</span></div><p class="text-xs text-slate-500 line-clamp-2 ml-6">${n.mensaje}</p></a></li>`;
                    });
                    list.innerHTML = html;
                } else {
                    badge.classList.add('hidden'); list.innerHTML = '<li class="p-6 text-center text-slate-400 text-xs">Sin novedades</li>';
                }
            }).catch(()=>{});
        }
        function markAsRead(id, link) {
            fetch(`/api/notificaciones/leer/${id}/`).then(() => { if(link && link !== '#') window.location.href = link; checkNotifications(); });
        }
        {% endif %}
    </script>
</body>
</html>