{% extends 'base.html' %}
{% block title %}Gestión de Inspecciones - CBT{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">

    <!-- ENCABEZADO -->
    <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4 border-b border-slate-200 pb-6">
        <div class="w-full md:w-auto">
            <h6 class="text-blue-600 font-bold text-xs tracking-widest uppercase mb-1">Operaciones</h6>
            <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Gestión de Inspecciones</h1>
        </div>
        
        <!-- Pestañas Superiores (Scrollable en móvil) -->
        <div class="w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
            <div class="bg-white p-1 rounded-xl border border-slate-200 shadow-sm flex min-w-[300px]">
                <button onclick="switchTab('programadas')" id="tab-programadas" class="flex-1 px-6 py-2 text-sm font-bold rounded-lg transition-all bg-slate-800 text-white shadow-md whitespace-nowrap">
                    Programadas
                </button>
                <button onclick="switchTab('historial')" id="tab-historial" class="flex-1 px-6 py-2 text-sm font-bold rounded-lg transition-all text-slate-500 hover:bg-slate-50 whitespace-nowrap">
                    Historial Completo
                </button>
            </div>
        </div>
    </div>

    <!-- VISTA 1: PROGRAMADAS (Activas) -->
    <div id="view-programadas" class="space-y-6">
        <div class="bg-white border border-slate-200 rounded-2xl shadow-apple overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex flex-wrap justify-between items-center gap-2">
                <h3 class="font-bold text-slate-800 text-sm uppercase tracking-wide flex items-center gap-2">
                    <i class="bi bi-calendar-check text-emerald-500"></i> Inspecciones Aceptadas
                </h3>
                <span class="bg-emerald-100 text-emerald-700 text-xs font-bold px-2.5 py-0.5 rounded-full border border-emerald-200">
                    {{ programadas|length }} Activas
                </span>
            </div>
            
            <!-- TABLA RESPONSIVA -->
            <div class="w-full">
                <table class="w-full text-left text-sm responsive-table">
                    <thead class="bg-slate-50 text-slate-500 uppercase text-xs font-bold hidden md:table-header-group">
                        <tr>
                            <th class="px-6 py-3">Fecha</th>
                            <th class="px-6 py-3">Local</th>
                            <th class="px-6 py-3">Contacto</th>
                            <th class="px-6 py-3 text-right">Acción</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 block md:table-row-group">
                        {% for turno in programadas %}
                        <tr class="hover:bg-slate-50 transition-colors block md:table-row p-4 md:p-0 border-b md:border-b-0 border-slate-100">
                            
                            <!-- Celda Fecha (Móvil: Header de tarjeta) -->
                            <td class="px-6 py-2 md:py-4 block md:table-cell" data-label="Fecha">
                                <div class="font-bold text-slate-800 text-lg md:text-sm">{{ turno.agenda.fecha|date:"d/m/Y" }}</div>
                                <span class="text-xs text-slate-500 bg-white border border-slate-200 px-1.5 py-0.5 rounded inline-block mt-1">{{ turno.get_bloque_display }}</span>
                            </td>

                            <td class="px-6 py-2 md:py-4 block md:table-cell" data-label="Local">
                                <div class="font-bold text-slate-900 text-base md:text-sm">{{ turno.establecimiento.nombre_comercial }}</div>
                                <div class="text-xs text-slate-500 flex items-center gap-1 mt-0.5">
                                    <i class="bi bi-geo-alt text-brand-red"></i> {{ turno.establecimiento.get_parroquia_display }}
                                </div>
                            </td>

                            <td class="px-6 py-2 md:py-4 block md:table-cell" data-label="Contacto">
                                <div class="flex flex-col gap-1">
                                    <div class="text-xs text-slate-600 flex items-center gap-2">
                                        <i class="bi bi-person-fill text-slate-400"></i> 
                                        {{ turno.establecimiento.propietario.first_name }}
                                    </div>
                                    <div class="text-xs text-slate-500 flex items-center gap-2">
                                        <i class="bi bi-telephone text-emerald-500"></i> 
                                        <a href="tel:{{ turno.telefono_contacto }}" class="hover:underline">{{ turno.telefono_contacto }}</a>
                                    </div>
                                </div>
                            </td>

                            <td class="px-6 py-4 block md:table-cell text-left md:text-right mt-2 md:mt-0">
                                <button onclick="abrirModalCancelacion('{{ turno.id }}', '{{ turno.establecimiento.nombre_comercial }}')" 
                                        class="w-full md:w-auto text-red-500 hover:text-red-700 hover:bg-red-50 px-3 py-2 md:py-1.5 rounded-lg text-xs font-bold border border-red-100 md:border-transparent hover:border-red-200 transition-all flex items-center justify-center md:justify-end gap-2">
                                    <i class="bi bi-x-circle"></i> Cancelar Cita
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="text-center py-12 text-slate-400 block md:table-cell">No hay inspecciones programadas.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- VISTA 2: HISTORIAL (Filtros) -->
    <div id="view-historial" class="hidden space-y-6">
        
        <!-- Filtros Responsive -->
        <div class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm">
            <form method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Búsqueda</label>
                    <div class="relative">
                        <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" name="q" value="{{ filtros.q }}" placeholder="Nombre, RUC..." class="w-full bg-slate-50 border border-slate-300 rounded-lg pl-9 pr-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Estado</label>
                    <select name="estado" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 cursor-pointer appearance-none">
                        <option value="">-- Todos --</option>
                        <option value="TERMINADO" {% if filtros.estado == 'TERMINADO' %}selected{% endif %}>Terminado</option>
                        <option value="CANCELADO" {% if filtros.estado == 'CANCELADO' %}selected{% endif %}>Cancelado</option>
                        <option value="RECHAZADO" {% if filtros.estado == 'RECHAZADO' %}selected{% endif %}>Rechazado</option>
                        <option value="NO_REALIZADA" {% if filtros.estado == 'NO_REALIZADA' %}selected{% endif %}>No Realizada</option>
                    </select>
                </div>
                <div>
                    <button type="submit" class="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-2 rounded-lg transition-colors text-sm shadow-sm">
                        Filtrar
                    </button>
                </div>
            </form>
        </div>

        <!-- Tabla Historial Responsive -->
        <div class="bg-white border border-slate-200 rounded-2xl shadow-apple overflow-hidden">
            <div class="w-full">
                <table class="w-full text-left text-sm responsive-table">
                    <thead class="bg-slate-50 text-slate-500 uppercase text-xs font-bold hidden md:table-header-group">
                        <tr>
                            <th class="px-6 py-3">Fecha</th>
                            <th class="px-6 py-3">Local</th>
                            <th class="px-6 py-3">Estado</th>
                            <th class="px-6 py-3 text-right">Detalle</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 block md:table-row-group">
                        {% for turno in historial %}
                        <tr class="hover:bg-slate-50 transition-colors block md:table-row p-4 md:p-0 border-b md:border-b-0 border-slate-100 relative">
                            
                            <td class="px-6 py-1 md:py-4 font-mono text-slate-600 block md:table-cell text-xs md:text-sm">
                                <span class="md:hidden font-bold text-slate-400 uppercase mr-2 text-[10px]">Fecha:</span>
                                {{ turno.agenda.fecha|date:"d/m/Y" }}
                            </td>
                            
                            <td class="px-6 py-1 md:py-4 font-medium text-slate-800 block md:table-cell text-lg md:text-sm">
                                {{ turno.establecimiento.nombre_comercial }}
                            </td>
                            
                            <td class="px-6 py-2 md:py-4 block md:table-cell">
                                {% if turno.estado == 'TERMINADO' %}
                                    <span class="badge bg-blue-50 text-blue-600 border-blue-100">TERMINADO</span>
                                {% elif turno.estado == 'CANCELADO' %}
                                    <span class="badge bg-red-50 text-red-600 border-red-100">CANCELADO</span>
                                {% elif turno.estado == 'NO_REALIZADA' %}
                                    <span class="badge bg-slate-100 text-slate-500 border-slate-200">AUSENTE</span>
                                {% endif %}
                            </td>
                            
                            <td class="px-6 py-2 md:py-4 text-left md:text-right text-xs text-slate-400 italic max-w-xs truncate block md:table-cell">
                                {{ turno.motivo_cancelacion|default:turno.observaciones|default:"--" }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- PAGINACIÓN (Se mantiene igual) -->
             {% if historial.has_other_pages %}
            <div class="px-6 py-4 border-t border-slate-200 bg-slate-50 flex flex-col sm:flex-row items-center justify-between gap-4">
                <span class="text-xs text-slate-500 font-medium">
                    Página <strong>{{ historial.number }}</strong> de <strong>{{ historial.paginator.num_pages }}</strong>
                </span>
                
                <div class="flex gap-2">
                    {% if historial.has_previous %}
                    <a href="?page={{ historial.previous_page_number }}{% if filtros.q %}&q={{ filtros.q }}{% endif %}{% if filtros.estado %}&estado={{ filtros.estado }}{% endif %}&tab=historial" 
                       class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-xs font-bold text-slate-600 hover:bg-slate-100 hover:text-blue-600 transition-colors shadow-sm">
                        Anterior
                    </a>
                    {% endif %}
                    
                    {% if historial.has_next %}
                    <a href="?page={{ historial.next_page_number }}{% if filtros.q %}&q={{ filtros.q }}{% endif %}{% if filtros.estado %}&estado={{ filtros.estado }}{% endif %}&tab=historial" 
                       class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-xs font-bold text-slate-600 hover:bg-slate-100 hover:text-blue-600 transition-colors shadow-sm">
                        Siguiente
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

</div>

<!-- MODAL DE CANCELACIÓN (Igual al anterior) -->
<div id="cancelModal" class="fixed inset-0 z-50 hidden bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform scale-100 transition-transform">
        <div class="p-5 border-b border-slate-100 bg-red-50 flex items-center gap-3">
            <div class="p-2 bg-white rounded-full text-red-500 shadow-sm"><i class="bi bi-x-circle-fill"></i></div>
            <h3 class="font-bold text-red-800">Cancelar Inspección</h3>
        </div>
        
        <form action="{% url 'cancelar_inspeccion_staff' %}" method="POST" class="p-6">
            {% csrf_token %}
            <input type="hidden" name="turno_id" id="modal_turno_id">
            <p class="text-sm text-slate-600 mb-4">
                Está a punto de cancelar la inspección de <strong id="modal_local_name" class="text-slate-900"></strong>.
            </p>
            <div class="mb-6">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Motivo</label>
                <textarea name="motivo" rows="3" class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-red-500/20 focus:border-red-500 outline-none resize-none" placeholder="Motivo..." required></textarea>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="cerrarModal()" class="px-4 py-2 rounded-lg border border-slate-300 text-slate-600 font-bold text-sm hover:bg-slate-50">Volver</button>
                <button type="submit" class="px-4 py-2 rounded-lg bg-red-600 text-white font-bold text-sm hover:bg-red-700 shadow-lg shadow-red-500/20">Confirmar</button>
            </div>
        </form>
    </div>
</div>

<style>
    .badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; border: 1px solid; }
    
    /* RESPONSIVE TABLES: En móvil, las celdas se vuelven bloques */
    @media (max-width: 768px) {
        .responsive-table, .responsive-table tbody, .responsive-table tr, .responsive-table td {
            display: block;
            width: 100%;
        }
        .responsive-table tr {
            margin-bottom: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
    }
</style>

<script>
    function switchTab(tab) {
        const v1 = document.getElementById('view-programadas');
        const v2 = document.getElementById('view-historial');
        const b1 = document.getElementById('tab-programadas');
        const b2 = document.getElementById('tab-historial');
        
        if (tab === 'programadas') {
            v1.classList.remove('hidden'); v2.classList.add('hidden');
            b1.className = "flex-1 px-6 py-2 text-sm font-bold rounded-lg transition-all bg-slate-800 text-white shadow-md whitespace-nowrap";
            b2.className = "flex-1 px-6 py-2 text-sm font-bold rounded-lg transition-all text-slate-500 hover:bg-slate-50 whitespace-nowrap";
        } else {
            v2.classList.remove('hidden'); v1.classList.add('hidden');
            b2.className = "flex-1 px-6 py-2 text-sm font-bold rounded-lg transition-all bg-slate-800 text-white shadow-md whitespace-nowrap";
            b1.className = "flex-1 px-6 py-2 text-sm font-bold rounded-lg transition-all text-slate-500 hover:bg-slate-50 whitespace-nowrap";
        }
    }

    function abrirModalCancelacion(id, nombre) {
        document.getElementById('modal_turno_id').value = id;
        document.getElementById('modal_local_name').innerText = nombre;
        document.getElementById('cancelModal').classList.remove('hidden');
    }

    function cerrarModal() {
        document.getElementById('cancelModal').classList.add('hidden');
    }
</script>
{% endblock %}